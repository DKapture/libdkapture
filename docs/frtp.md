# frtp - 文件保护工具

## 简介

`frtp`（File Real-time Protection）是一个基于 eBPF 技术的文件实时保护工具，能够根据策略文件对系统文件进行访问控制，防止恶意程序对重要文件的非法访问。该工具通过拦截文件系统调用，实现对特定进程或程序对指定文件的读、写操作的精确控制。

## 主要功能

- **实时文件保护**：基于 eBPF LSM（Linux Security Module）钩子，实时监控文件访问
- **灵活的策略配置**：支持基于进程名或进程 ID 的访问控制规则
- **多种文件操作拦截**：支持对文件打开、截断、删除、创建目录等操作的控制
- **递归目录保护**：支持对目录及其子目录的递归保护
- **访问日志记录**：记录所有被拦截的文件访问尝试

## 编译构建

在项目根目录下执行：

```bash
make policy/frtp
```

## 使用方法

### 基本语法

```bash
./frtp [选项]
```

### 命令行选项

- `-p, --policy-file <策略文件>`：指定策略文件路径（默认：frtp.pol）
- `-h, --help`：显示帮助信息

### 示例

```bash
# 使用默认策略文件 frtp.pol
sudo ./frtp

# 指定自定义策略文件
sudo ./frtp -p /path/to/custom.pol

# 显示帮助信息
./frtp -h
```

## 策略文件格式

策略文件采用简单的文本格式，每行定义一条规则。

### 基本语法

```
forbid <类型>=<标识符> <操作> <目标路径>
```

### 参数说明

#### 类型（type）
- `proc`：基于进程名的规则
- `pid`：基于进程 ID 的规则

#### 标识符（identifier）
- 对于 `proc` 类型：进程的可执行文件路径，支持通配符 `*`
- 对于 `pid` 类型：具体的进程 ID 数字

#### 操作（action）
- `r`：禁止读操作
- `w`：禁止写操作
- `rw`：禁止读写操作

#### 目标路径（target_path）
- 具体的文件路径
- 目录路径（以 `/` 结尾或 `/*` 结尾表示递归保护该目录）

### 策略文件示例

```bash
# 禁止 cat 命令读写 /root/file 文件
forbid proc=/usr/bin/cat rw /root/file

# 禁止 /usr/bin/ 目录下的所有程序写入 /root/file
forbid proc=/usr/bin/* w /root/file

# 禁止特定进程 ID 写入 /root/ 目录下的所有文件
forbid pid=31693 w /root/*

# 禁止 /usr/local/bin/ 下的所有程序读写 /root/ 目录
forbid proc=/usr/local/bin/* rw /root/*

# 注释行以 # 开头
# 这是一条注释
```

### 通配符支持

- `*`：匹配任意数量的字符
- 路径末尾的 `/*` 或 `/`：表示递归保护目录及其子目录

## 工作原理

### eBPF 程序架构

`frtp` 工具由两部分组成：

1. **用户空间程序**（frtp.cpp）：
   - 解析命令行参数和策略文件
   - 加载和管理 eBPF 程序
   - 处理访问日志输出

2. **内核空间 eBPF 程序**（frtp.bpf.c）：
   - 挂载到 LSM 钩子点
   - 实时拦截文件系统调用
   - 执行访问控制逻辑

### LSM 钩子点

工具挂载到以下 LSM 钩子点：

- `file_open`：文件打开操作
- `file_truncate`：文件截断操作
- `path_unlink`：文件删除操作
- `path_mkdir`：目录创建操作
- `path_rmdir`：目录删除操作
- `path_mknod`：特殊文件创建操作

### 数据结构

#### BPF Maps

- `filter`：存储策略规则的哈希表
- `pid2path`：进程 ID 到可执行文件路径的映射
- `logs`：环形缓冲区，用于记录访问日志

## 运行环境要求

- Linux 内核版本 ≥ 5.8（支持 BPF LSM）
- 启用 BPF LSM 支持的内核配置
- 需要 root 权限运行

## 日志输出

当有文件访问被拦截时，工具会输出如下格式的日志：

```
[时间戳]!!!: 进程名[进程ID] tried to 操作类型 (设备,inode信息), denied!
```

示例：
```
[2024-01-15 10:30:45]!!!: /usr/bin/cat[12345] tried to read (/dev/sda1 inode:123456), denied!
```

## 注意事项

1. **权限要求**：必须以 root 权限运行，因为需要加载 eBPF 程序到内核
2. **内核支持**：确保内核支持 BPF LSM 功能
3. **策略文件格式**：确保策略文件格式正确，错误的规则会被跳过
4. **性能影响**：虽然 eBPF 性能较好，但大量的规则可能会影响系统性能
5. **文件存在性**：策略文件中指定的目标路径必须存在，否则规则会被忽略

## 故障排除

### 常见问题

1. **权限被拒绝**：确保以 root 权限运行
2. **BPF 程序加载失败**：检查内核是否支持 BPF LSM
3. **策略规则不生效**：检查策略文件格式和目标文件是否存在
4. **trace pipe 被占用**：其他调试工具可能正在使用 trace pipe
