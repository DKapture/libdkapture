# net-filter

此项目是基于1060系统版本上的net-filter重构而来的，其基本功能与初始net-filter相同，不同的是实现方式，初版net-filter是基于内核模块实现的，而本次重构是基于eBPF来实现的，重构版本适用于UOS v25版本。

## 功能描述

本工具可以用于网络抓包，网络包过滤。过滤的方式通过配置文件设定，具体配置文件的语法设计，请参考规则语法章节。

## 使用方法

```bash
$ ./filter/net-filter -h
Usage: ./filter/net-filter [option]
options:
  -p, --policy <path>
        set the policy file path
        default: /etc/net-monitor/policy.conf

  -h, --help 
        print this help message

  -d, --debug [level]
        set debug log level:
        0: no debug(default)
        1: output TCP package capture with LSM
        2: output UDP package capture with LSM
        3: output ICMP package capture with LSM
        4: output all package capture with LSM
        5: outtput TCP package capture with NETFILTER
        6: outtput UDP package capture with NETFILTER
        7: outtput ICMP package capture with NETFILTER
        8: outtput all package capture with NETFILTER
        9: outtput all package capture while rule matching
```

-p：设置过滤规则的配置文件路径。

## 规则

### 语法

规则以行为单位，可以将规则写入配置文件，方便读取。具体字段定义如下：

```

<proto/[dir]> <sip> <dip> <sport> <dport> <tl-proto> <action> [comm]

```

- proto   : ip协议，可取ipv4/ipv6
- dir     : 网络包的方向，any/in/out, 可选项，默认any，即出包和入包都包含。
- sip     : 源ip地址，支持使用 '--' 来连接两个ip，表示一个ip段，支持标准的ipv4/ipv6字符串表示法。
- dip     : 目的ip地址，用法同sip
- sport   : 源端口，支持使用 '--' 来连接两个端口，表示一个端口范围
- dport   : 目的端口，用法同sport
- tl-proto: 传输层协议，可去tcp/udp/icmp，icmp实际介于网络层和传输层之间。
- action  : 拦截到包后的行为，可取drop/log，drop指丢弃包，log指仅记录日志，这项可以多选，用逗号分割，例如'drop,log'
- comm    : 需要过滤进程名，16个字符以内，这项是可选项。注意，这项不可与icmp同时使用。

配置文件支持以 `#`号开头表示注释，允许前导空格。

### 示例

```ini

# policy.conf


# 正确语法

ipv4/in 192.168.122.1--192.168.122.255 192.168.122.1--192.168.122.255 0 0 tcp log ssh

# 错误：ip地址非法

ipv4/out fe80::3c3:6906:8afd:2640--fe80::3c3:6906:8afd:2660 :: 0 0 udp log

# 错误：不能与icmp同时使用

ipv6 fe80::3c3:6906:8afd:2640--fe80::3c3:6906:8afd:2660 :: 0 0 icmp log ping

# 正确语法

ipv6 fe80::3c3:6906:8afd:2640--fe80::3c3:6906:8afd:2660 :: 0 0 udp log

# 错误：参数过少，缺少必选项。

ipv6/any fe80::3c3:6906:8afd:2640--fe80::3c3:6906:8afd:2660

# 正确语法

ipv6 fe80::3c3:6906:8afd:2640--fe80::3c3:6906:8afd:2660 fe80::8b65:d3de:99b0:df00--fe80::8b65:d3de:99b0:dfff 1--60000 1--60000 icmp log in

# 正确语法

ipv6/any fd60:5c20:5731:0000:6df7:a7f2:5363:3800--fd60:5c20:5731:0000:6df7:a7f2:5363:38ff :: 0 0 tcp drop,log

```

## 工具示例

```
$ sudo ./filter/net-filter -p conf.txt
请输入密码:
验证成功
[15:02:13]: ************ new start for net-monitor ************
bpf program/map loaded....
[15:02:13]: rules size: 1
[15:02:13]: ============== rule ==============
[15:02:13]: src: 0.0.0.0-0.0.0.0 : 0-0
[15:02:13]: dst: 0.0.0.0-0.0.0.0 : 0-0
[15:02:13]: pkg_dir: any
[15:02:13]: proto: tcp
[15:02:13]: comm: 
[15:02:13]: action: log

[15:02:14]: 343611312101 (:0) tcp 10.20.12.125:52796 -> 169.254.169.254:80 sz(30)
[15:02:14]: 343611514379 (:3096) tcp 10.20.12.125:42472 -> 169.254.169.254:80 sz(30)
[15:02:14]: 343611518341 (:3125) tcp 10.20.12.125:42474 -> 169.254.169.254:80 sz(30)
[15:02:14]: 343611779011 (:240266) tcp 10.20.12.125:58162 -> 20.189.172.73:443 sz(30)
[15:02:15]: 343611933151 (:0) tcp 10.20.12.125:58162 <- 20.189.172.73:443 sz(30)
[15:02:15]: 343611933181 (:0) tcp 10.20.12.125:58162 -> 20.189.172.73:443 sz(24)
[15:02:15]: 343611933415 (:240266) tcp 10.20.12.125:58162 -> 20.189.172.73:443 sz(541)
[15:02:15]: 343612088143 (:0) tcp 10.20.12.125:58162 <- 20.189.172.73:443 sz(123)
[15:02:15]: 343612088195 (:0) tcp 10.20.12.125:58162 -> 20.189.172.73:443 sz(24)
[15:02:15]: 343612089733 (:240266) tcp 10.20.12.125:58162 -> 20.189.172.73:443 sz(470)
[15:02:15]: 343612246278 (:0) tcp 10.20.12.125:58162 <- 20.189.172.73:443 sz(1472)
[15:02:15]: 343612246538 (:0) tcp 10.20.12.125:58162 -> 20.189.172.73:443 sz(24)
[15:02:15]: 343612248097 (:240266) tcp 10.20.12.125:58162 -> 20.189.172.73:443 sz(322)
^C
[15:02:15]: rules size after cleaning: 0
[15:02:16]: *************** net-monitor exited ***************
```

在抓包输出当中，可以看到，以空格分隔的信息输出，取其中一例解释如下：

`[15:02:14]: 343611312101 (:0) tcp 10.20.12.125:52796 -> 169.254.169.254:80 sz(30)`

- `[15:02:14]` 是抓包的时间，精确到秒。
- `343611312101` 也是抓包的时间，精确到毫秒。
- `(:0)` 是进程相关信息，表示当前数据包是由哪个进程负责发送，注意这里实际上是以分号分隔的两个数据，分号左边是进程名，右边是进程pid，如果进程名为空，则表示当前进程只是发送该数据包的代理进程，并不是实际上请求发送该包的进程。进程名仅会在指定进程名过滤时显示。
- `tcp` 是该数据包使用的协议
- `10.20.12.125:52796` 是源ip源端口地址。
- `->` 表示数据包的方向，向左，则表示本机接收的数据包，向右，则表示本机发送的数据包。
- `169.254.169.254:80` 是目的ip目的端口地址。
- `sz(30)` 表示该数据包产生的流量大小。
