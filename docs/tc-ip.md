# tc-ip

## 功能描述

`tc-ip` 是一个基于 eBPF 和 Netfilter 的网络流量控制工具，通过 Linux Netfilter 钩子实现网络协议级的流量控制、速率限制和监控。与接口级限速工具不同，tc-ip 工作在 Netfilter 层面，对所有经过的网络流量进行统一的规则匹配、速率控制和统计收集。

该工具特别适用于：
- 全局网络流量监控和分析
- 基于 IP、端口、协议的精确流量控制
- 网络带宽管理和 QoS 策略实施
- 网络安全审计和流量分析

## 主要特性

- **Netfilter级控制**：基于 Linux Netfilter 框架，影响所有网络流量
- **灵活规则匹配**：支持 IP 地址、端口、协议类型的组合匹配
- **多方向支持**：同时支持入站（ingress）和出站（egress）方向的流量控制
- **多种规则类型**：支持速率限制、丢弃、日志记录三种规则类型
- **令牌桶算法**：基于令牌桶算法的精确速率控制
- **实时统计**：提供全局、IP、端口的流量统计和速率计算
- **事件监控**：通过 ring buffer 实时报告流量事件
- **安全设计**：完整的错误处理和内存安全机制
- **统一日志**：集成 Ulog.h 日志系统，提供结构化日志输出

## 构建

```bash
cd filter
make tc-ip
```

依赖：libbpf、clang/LLVM、bpftool、内核头文件（详见 `filter/Makefile`）。

## 使用方法

```bash
sudo ./filter/tc-ip -h
```

### 参数说明

- `-i, --ip <ip>`：目标 IP 地址（可选，使用 'any' 表示所有 IP）
- `-p, --port <port>`：目标端口（可选，使用 'any' 表示所有端口）
- `-P, --protocol <proto>`：目标协议（可选：tcp/udp/any）
- `-r, --rate <rate>`：速率限制，支持 K/M/G 后缀（如 `100K`、`1M`、`2G`）
- `-d, --direction <dir>`：匹配方向（egress/ingress）
- `-t, --timescale <sec>`：时间尺度（秒），控制突发容忍度
- `-T, --rule-type <type>`：规则类型（rate/drop/log，默认：rate）
- `-D, --drop`：快捷方式，设置规则类型为 drop
- `-L, --log`：快捷方式，设置规则类型为 log
- `-h, --help`：显示帮助信息

### 使用示例

```bash
# 将来自 192.168.1.1 的流量限速到 100 Mbps，时间尺度 60s
sudo ./filter/tc-ip -i 192.168.1.1 -r 100M -t 60

# 将目标端口 80 的 TCP 流量限速到 50 Mbps
sudo ./filter/tc-ip -p 80 -P tcp -r 50M -t 30

# 丢弃来自特定 IP 的流量
sudo ./filter/tc-ip -i 192.168.1.100 -T drop

# 记录 SSH 流量（端口 22）
sudo ./filter/tc-ip -p 22 -T log

# 组合匹配：限速特定 IP 和端口的流量
sudo ./filter/tc-ip -i 192.168.1.1 -p 80 -r 10M -t 60

# 全局流量控制：限速所有流量
sudo ./filter/tc-ip -r 1G -t 3600

# 方向控制：只控制出站流量
sudo ./filter/tc-ip -d egress -r 500M -t 60
```

## 工作原理

### 架构概述

tc-ip 使用 Netfilter 钩子挂载 eBPF 程序到网络协议栈，实现以下功能：

1. **流量解析**：解析 IP、TCP/UDP 头部，提取五元组信息
2. **规则匹配**：根据配置的规则进行流量匹配
3. **速率控制**：基于令牌桶算法实现流量整形
4. **统计收集**：收集和更新各种维度的流量统计信息
5. **事件报告**：通过 ring buffer 向用户空间报告流量事件

### 核心算法

#### 令牌桶算法
- **基本限速**：标准令牌桶实现，严格控制流量
- **突发容忍**：支持配置时间尺度的令牌桶，允许短期流量突发
- **动态调整**：根据时间差动态计算令牌补充

#### 流量统计算法
- **多维度统计**：全局、IP、端口的流量统计
- **实时更新**：基于时间差的速率计算
- **峰值记录**：记录观察到的峰值流量速率

### 协议支持

| 协议类型 | 协议号 | 描述 |
|---------|--------|------|
| TCP     | 6      | 传输控制协议 |
| UDP     | 17     | 用户数据报协议 |
| 其他    | 其他   | 其他 IP 协议 |

### 规则类型

| 规则类型 | 值 | 描述 |
|---------|----|------|
| 速率限制 | 0  | 基于令牌桶算法的流量控制 |
| 丢弃     | 1  | 直接丢弃匹配的流量 |
| 日志记录 | 2  | 记录匹配流量的信息 |

### 匹配方向

| 方向   | 值 | 描述 |
|--------|----|------|
| INGRESS | 0  | 入站流量（从源接收） |
| EGRESS  | 1  | 出站流量（发送到目标） |

## 输出示例

### 实时流量事件

程序运行时会实时显示网络流量信息，包括：

```
[DKapture][tc-ip.cpp:794][info] Traffic: 192.168.122.229:22 -> 192.168.122.1:57926 [PASS] 160 bytes
[DKapture][tc-ip.cpp:794][info] Traffic: 127.0.0.1:32785 -> 127.0.0.1:47410 [PASS] 120 bytes
[DKapture][tc-ip.cpp:794][info] Traffic: 192.168.122.1:57926 -> 192.168.122.229:22 [PASS] 176 bytes
[DKapture][tc-ip.cpp:794][info] Traffic: 127.0.0.1:46438 -> 127.0.0.1:32785 [PASS] 142 bytes
```

**输出格式说明**：
- `[DKapture]`：工具标识前缀
- `[tc-ip.cpp:794]`：日志来源文件和行号
- `[info]`：日志级别
- `Traffic: src_ip:src_port -> dst_ip:dst_port [ACTION] bytes`：流量信息
  - `src_ip:src_port`：源IP地址和端口
  - `dst_ip:dst_port`：目标IP地址和端口
  - `[ACTION]`：动作类型（PASS/DROP/RATE_LIMIT_DROP/LOG）
  - `bytes`：数据包大小

**常见流量类型**：
- **SSH 连接**：如 `192.168.122.229:22` 表示 SSH 服务
- **本地回环**：如 `127.0.0.1:32785` 表示本地进程间通信
- **动态端口**：如 `57926`、`47410` 等表示客户端使用的临时端口

### 配置确认

程序启动时会显示配置信息：

```
Match criteria:
  IP: 192.168.1.1
  Port: 80
  Protocol: 6 (TCP)
Rule type: Rate limiting (100000000 B/s)
Match direction: INGRESS (source)
Time scale: 60 seconds (max bucket capacity: 5.86 MB)
```

## 技术特性

### BPF 程序特性

- **安全验证**：通过 BPF 验证器确保程序安全性
- **高效执行**：在内核空间直接处理网络数据包
- **内存安全**：使用 `bpf_dynptr` 安全访问 sk_buff 数据
- **调试支持**：集成 Kcom.h 调试宏，支持运行时调试
- **方向感知**：正确处理 ingress/egress 方向的 IP 和端口提取

### 用户空间特性

- **错误处理**：完整的错误处理机制和日志记录
- **内存管理**：安全的字符串和内存管理
- **重试机制**：支持操作失败后的指数退避重试
- **信号处理**：优雅的信号处理和程序退出
- **统一日志**：使用 Ulog.h 提供结构化、带颜色的日志输出

### 性能特性

- **低延迟**：内核空间直接处理，最小化延迟
- **高吞吐**：优化的数据结构和算法
- **资源效率**：最小化内存和 CPU 占用
- **可扩展性**：支持大量规则和统计条目

## 配置说明

### 时间尺度配置

| 时间尺度 | 突发容忍度 | 适用场景 |
|---------|------------|----------|
| 1s      | 低         | 严格限速，低突发容忍 |
| 60s     | 中         | 平衡限速，允许短期突发 |
| 3600s   | 高         | 宽松限速，长期带宽管理 |

### 匹配掩码

匹配掩码使用位标志控制哪些字段参与匹配：

- **位 0**：IP 地址匹配
- **位 1**：端口匹配  
- **位 2**：协议匹配

例如：`match_mask = 3` 表示同时匹配 IP 和端口。

### 速率单位

支持多种速率单位：

- **无后缀**：字节/秒
- **K**：千字节/秒（×1024）
- **M**：兆字节/秒（×1024²）
- **G**：吉字节/秒（×1024³）

## 实际应用场景

### 网络监控
- **实时流量分析**：监控网络使用模式和异常流量
- **带宽使用统计**：了解不同 IP 和端口的带宽占用情况
- **协议分析**：分析 TCP/UDP 流量的分布和特征

### 流量控制
- **QoS 策略**：为不同服务设置优先级和带宽限制
- **DDoS 防护**：限制异常流量的速率
- **带宽管理**：控制特定用户或服务的网络使用

### 安全审计
- **访问日志**：记录网络访问的详细信息
- **异常检测**：识别不正常的网络行为模式
- **合规监控**：满足网络安全审计要求

## 故障排除

### 常见问题

1. **权限不足**
   ```
   [DKapture][tc-ip.cpp:888][error] This program must be run with root privileges
   ```
   解决：使用 `sudo` 运行程序

2. **BPF 程序加载失败**
   ```
   [DKapture][tc-ip.cpp:900][error] Failed to open and load BPF skeleton
   ```
   解决：检查内核版本是否支持 eBPF，确保 libbpf 库正确安装

3. **Netfilter 钩子附加失败**
   ```
   [DKapture][tc-ip.cpp:920][error] Failed to attach netfilter program
   ```
   解决：检查内核是否支持 Netfilter eBPF 钩子

### 调试方法

1. **启用调试输出**：程序集成了 Kcom.h 调试宏
2. **查看内核日志**：使用 `dmesg` 或 `journalctl` 查看 BPF 程序输出
3. **检查系统调用**：使用 `strace` 跟踪系统调用
4. **监控日志输出**：观察程序运行时的实时日志信息

### 性能调优

1. **调整时间尺度**：根据网络特性选择合适的突发容忍度
2. **优化规则数量**：减少不必要的规则匹配
3. **监控资源使用**：关注内存和 CPU 占用情况
4. **日志级别控制**：根据需要调整日志输出详细程度

## 安全考虑

- **权限要求**：需要 root 权限运行
- **内核安全**：BPF 程序通过验证器确保安全性
- **资源限制**：内置资源使用限制和错误处理
- **审计日志**：完整的操作日志和错误记录
- **网络隔离**：影响全局网络流量，需谨慎配置
